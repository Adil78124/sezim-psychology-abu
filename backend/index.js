require('dotenv').config();
const express = require('express');
const https = require('https');
const rateLimit = require('express-rate-limit');
const cors = require('cors');

const app = express();

// Middleware
app.use(cors({
  origin: process.env.FRONTEND_URL || '*',
  credentials: true
}));
app.use(express.json());

// ÐžÐ³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸Ðµ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð² â€” Ð·Ð°Ñ‰Ð¸Ñ‚Ð° Ð¾Ñ‚ Ð°Ð±ÑƒÐ·Ð°
const limiter = rateLimit({
  windowMs: 60 * 1000, // 1 Ð¼Ð¸Ð½ÑƒÑ‚Ð°
  max: 10,             // Ð¼Ð°ÐºÑÐ¸Ð¼ÑƒÐ¼ 10 Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð² Ð² Ð¼Ð¸Ð½ÑƒÑ‚Ñƒ Ñ Ð¾Ð´Ð½Ð¾Ð³Ð¾ IP
  message: { error: "Ð¡Ð»Ð¸ÑˆÐºÐ¾Ð¼ Ð¼Ð½Ð¾Ð³Ð¾ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð². ÐŸÐ¾Ð´Ð¾Ð¶Ð´Ð¸Ñ‚Ðµ Ð½ÐµÐ¼Ð½Ð¾Ð³Ð¾." }
});
app.use("/api/", limiter);

// Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ð² Telegram
function sendToTelegram(token, chatId, text) {
  return new Promise((resolve, reject) => {
    const params = new URLSearchParams({
      chat_id: chatId,
      text: text
    });

    const options = {
      hostname: 'api.telegram.org',
      path: `/bot${token}/sendMessage`,
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'Content-Length': Buffer.byteLength(params.toString())
      }
    };

    const req = https.request(options, (res) => {
      let responseData = '';

      res.on('data', (chunk) => {
        responseData += chunk;
      });

      res.on('end', () => {
        try {
          const parsed = JSON.parse(responseData);
          console.log('ðŸ“¥ ÐžÑ‚Ð²ÐµÑ‚ Ð¾Ñ‚ Telegram:', parsed.ok ? 'âœ… OK' : 'âŒ ' + parsed.description);
          if (parsed.ok) {
            resolve(parsed);
          } else {
            reject(new Error(parsed.description || 'Telegram API error'));
          }
        } catch (e) {
          reject(e);
        }
      });
    });

    req.on('error', (error) => {
      reject(error);
    });

    req.write(params.toString());
    req.end();
  });
}

// ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐº Telegram Ð¿Ñ€Ð¸ ÑÑ‚Ð°Ñ€Ñ‚Ðµ
const BOT_TOKEN = process.env.TELEGRAM_BOT_TOKEN;
const CHAT_ID = process.env.TELEGRAM_CHAT_ID;

if (!BOT_TOKEN || !CHAT_ID) {
  console.error('âŒ TELEGRAM_BOT_TOKEN Ð¸Ð»Ð¸ TELEGRAM_CHAT_ID Ð½Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½Ñ‹ Ð² .env Ñ„Ð°Ð¹Ð»Ðµ');
  console.log('âš ï¸  Ð”Ð¾Ð±Ð°Ð²ÑŒÑ‚Ðµ Ð¸Ñ… Ð´Ð»Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹');
} else {
  console.log('âœ… Telegram Bot Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½ Ð¸ Ð³Ð¾Ñ‚Ð¾Ð² Ðº Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹');
  console.log(`ðŸ“± Chat ID: ${CHAT_ID}`);
}

// Health check endpoint
app.get('/api/health', (req, res) => {
  res.json({ 
    ok: true, 
    status: 'Backend Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚!',
    timestamp: new Date().toISOString()
  });
});

// Endpoint Ð´Ð»Ñ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹ Ð² Telegram
app.post('/api/send', async (req, res) => {
  const { email, subject, message, name, phone } = req.body || {};
  
  // Ð’Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ñ Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ñ… Ð¿Ð¾Ð»ÐµÐ¹
  if (!email || !subject || !message) {
    return res.status(400).json({ 
      error: "ÐŸÐ¾Ð»Ñ email, subject Ð¸ message Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹" 
    });
  }

  // Ð’Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ñ email
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!emailRegex.test(email)) {
    return res.status(400).json({ 
      error: "ÐÐµÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ñ‹Ð¹ email Ð°Ð´Ñ€ÐµÑ" 
    });
  }

  // ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐº Telegram
  if (!BOT_TOKEN || !CHAT_ID) {
    return res.status(500).json({ 
      error: "Telegram Ð½Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ" 
    });
  }

  try {
    // Ð¤Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÐµÐ¼ Ð¿Ñ€Ð¾ÑÑ‚Ð¾Ðµ Ñ‚ÐµÐºÑÑ‚Ð¾Ð²Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð´Ð»Ñ Telegram
    const telegramMessage = `ðŸ“© ÐÐ¾Ð²Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ñ ÑÐ°Ð¹Ñ‚Ð° Sezim Psychology

ðŸ‘¤ Ð˜Ð¼Ñ: ${name || 'ÐÐµ ÑƒÐºÐ°Ð·Ð°Ð½Ð¾'}
ðŸ“§ Email: ${email}
${phone ? `ðŸ“ž Ð¢ÐµÐ»ÐµÑ„Ð¾Ð½: ${phone}\n` : ''}ðŸŽ¯ Ð¢ÐµÐ¼Ð°: ${subject}

ðŸ’¬ Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ:
${message}

â° Ð’Ñ€ÐµÐ¼Ñ: ${new Date().toLocaleString('ru-RU', { timeZone: 'Asia/Almaty' })}`;

    console.log('ðŸ“¤ ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÑŽ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ:', telegramMessage.substring(0, 100) + '...');
    console.log('ðŸ“ Ð”Ð»Ð¸Ð½Ð° ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ:', telegramMessage.length);

    // ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ð² Telegram
    const result = await sendToTelegram(BOT_TOKEN, CHAT_ID, telegramMessage);
    
    console.log('âœ… Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¾ Ð² Telegram');
    console.log(`   ÐžÑ‚: ${name || 'ÐÐ½Ð¾Ð½Ð¸Ð¼'} (${email})`);
    console.log(`   Ð¢ÐµÐ¼Ð°: ${subject}`);
    
    return res.json({ 
      ok: true, 
      message: 'Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¾! ÐœÑ‹ ÑÐ²ÑÐ¶ÐµÐ¼ÑÑ Ñ Ð²Ð°Ð¼Ð¸ Ð² Ð±Ð»Ð¸Ð¶Ð°Ð¹ÑˆÐµÐµ Ð²Ñ€ÐµÐ¼Ñ.',
      telegramMessageId: result.result.message_id
    });
    
  } catch (err) {
    console.error("âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸ Ð² Telegram:", err.message);
    return res.status(500).json({ 
      error: "ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ", 
      details: err.message 
    });
  }
});

// Endpoint Ð´Ð»Ñ Ð¼Ð°ÑÑÐ¾Ð²Ð¾Ð¹ Ñ€Ð°ÑÑÑ‹Ð»ÐºÐ¸ Ð² Telegram (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾, Ñ Ð·Ð°Ñ‰Ð¸Ñ‚Ð¾Ð¹)
app.post('/api/send-bulk', async (req, res) => {
  const { message } = req.body || {};
  
  // Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð°Ñ Ð·Ð°Ñ‰Ð¸Ñ‚Ð° - Ñ‚Ñ€ÐµÐ±ÑƒÐµÐ¼ API ÐºÐ»ÑŽÑ‡
  const apiKey = req.headers['x-api-key'];
  if (apiKey !== process.env.ADMIN_API_KEY) {
    return res.status(403).json({ 
      error: "Ð”Ð¾ÑÑ‚ÑƒÐ¿ Ð·Ð°Ð¿Ñ€ÐµÑ‰ÐµÐ½. Ð¢Ñ€ÐµÐ±ÑƒÐµÑ‚ÑÑ API ÐºÐ»ÑŽÑ‡ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð°" 
    });
  }

  if (!message) {
    return res.status(400).json({ 
      error: "ÐŸÐ¾Ð»Ðµ message Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾" 
    });
  }

  if (!BOT_TOKEN || !CHAT_ID) {
    return res.status(500).json({ 
      error: "Telegram Ð½Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ" 
    });
  }

  try {
    // Ð¤Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÐµÐ¼ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð´Ð»Ñ Ð¼Ð°ÑÑÐ¾Ð²Ð¾Ð¹ Ñ€Ð°ÑÑÑ‹Ð»ÐºÐ¸
    const telegramMessage = `ðŸ“¢ Ð Ð°ÑÑÑ‹Ð»ÐºÐ° Ð¾Ñ‚ Sezim Psychology

${message}

â° ${new Date().toLocaleString('ru-RU', { timeZone: 'Asia/Almaty' })}`;

    // ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ð² Telegram
    await sendToTelegram(BOT_TOKEN, CHAT_ID, telegramMessage);
    
    console.log('âœ… ÐœÐ°ÑÑÐ¾Ð²Ð°Ñ Ñ€Ð°ÑÑÑ‹Ð»ÐºÐ° Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð° Ð² Telegram');
    
    return res.json({ 
      ok: true, 
      message: 'Ð Ð°ÑÑÑ‹Ð»ÐºÐ° ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð° Ð² Ð³Ñ€ÑƒÐ¿Ð¿Ñƒ'
    });
    
  } catch (err) {
    console.error("âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¼Ð°ÑÑÐ¾Ð²Ð¾Ð¹ Ñ€Ð°ÑÑÑ‹Ð»ÐºÐ¸:", err);
    return res.status(500).json({ 
      error: "ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¼Ð°ÑÑÐ¾Ð²Ð¾Ð¹ Ñ€Ð°ÑÑÑ‹Ð»ÐºÐµ", 
      details: err.message 
    });
  }
});

// 404 handler
app.use((req, res) => {
  res.status(404).json({ error: "Endpoint Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½" });
});

// Error handler
app.use((err, req, res, next) => {
  console.error('ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐµÑ€Ð²ÐµÑ€Ð°:', err);
  res.status(500).json({ error: "Ð’Ð½ÑƒÑ‚Ñ€ÐµÐ½Ð½ÑÑ Ð¾ÑˆÐ¸Ð±ÐºÐ° ÑÐµÑ€Ð²ÐµÑ€Ð°" });
});

// Ð—Ð°Ð¿ÑƒÑÐº ÑÐµÑ€Ð²ÐµÑ€Ð°
const PORT = process.env.PORT || 5000;
app.listen(PORT, () => {
  console.log(`\nðŸš€ Backend Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð½Ð° Ð¿Ð¾Ñ€Ñ‚Ñƒ ${PORT}`);
  console.log(`ðŸ“¡ Health check: http://localhost:${PORT}/api/health`);
  console.log(`ðŸ“¬ Send endpoint: http://localhost:${PORT}/api/send\n`);
});

