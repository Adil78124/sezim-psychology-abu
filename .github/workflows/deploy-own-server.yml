name: Deploy to Own Server

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          
      - name: Clean and install dependencies
        run: |
          rm -rf node_modules package-lock.json
          npm install
          cd backend && rm -rf node_modules package-lock.json && npm install
          
      - name: Build frontend
        run: npm run build
        
      - name: Deploy to server
        if: ${{ secrets.HOST != '' && secrets.USERNAME != '' && secrets.SSH_KEY != '' }}
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.PORT || 22 }}
          script: |
            # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞
            cd /path/to/sezim.abu.edu.kz
            
            # –ü–æ–ª—É—á–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
            git pull origin main
            
            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
            npm install
            cd backend && npm install
            
            # –°–æ–±–∏—Ä–∞–µ–º —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥
            npm run build
            
            # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º backend
            pm2 restart psychology-backend || pm2 start backend/index.js --name psychology-backend
            
            # –ö–æ–ø–∏—Ä—É–µ–º —Å–æ–±—Ä–∞–Ω–Ω—ã–π —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –≤ –≤–µ–±-–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
            cp -r dist/* /var/www/html/ || cp -r dist/* /home/user/public_html/
            
            echo "Deployment completed successfully!"
            
      - name: Skip server deployment
        if: ${{ secrets.HOST == '' || secrets.USERNAME == '' || secrets.SSH_KEY == '' }}
        run: |
          echo "‚ö†Ô∏è Server deployment skipped - SSH secrets not configured"
          echo "To enable server deployment, configure these secrets in GitHub:"
          echo "- HOST: your server IP/hostname"
          echo "- USERNAME: your server username"
          echo "- SSH_KEY: your private SSH key"
          echo "- PORT: SSH port (optional, defaults to 22)"
          echo ""
          echo "‚úÖ Frontend build completed successfully!"
          echo "üìÅ Built files are in the 'dist' directory"
